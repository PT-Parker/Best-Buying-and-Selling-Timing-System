# Feature Specification: Unified CLI for Backtesting & Deliverables

**Feature Branch**: `001-unified-cli-for`  
**Created**: 2025-10-18  
**Status**: Draft  
**Input**: User description: "Unified CLI for backtesting and signals; subcommands backtest one/all, signals, plot; tasks build_slides and package_deliverables"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 批次回測與產出管理 (Priority: P1)

身為投資人/分析師，我希望用單一指令針對設定好的多檔標的在指定區間進行回測，並產出可追蹤的成果（資產曲線圖、交易點清單），以便快速比較與留存。

**Why this priority**: 這是整體流程的核心價值來源，直接產出決策所需的回測資料與圖表。

**Independent Test**: 使用既有設定（標的清單、期間、費用/滑價）執行批次回測，驗證每個標的皆產出圖檔與紀錄檔，並於終端顯示摘要績效。

**Acceptance Scenarios**:
1. Given 設定檔包含至少 1 檔標的與有效期間，When 執行批次回測，Then 每檔標的皆生成資產曲線圖與交易點清單，並顯示年化報酬與最大回撤摘要。
2. Given 設定檔缺漏必要欄位（如期間），When 執行批次回測，Then 清楚提示缺失欄位並以非零代碼結束或採用明確的預設值（有記錄）。

---

### User Story 2 - 今日訊號彙總 (Priority: P2)

身為投資人，我希望在收盤（或指定時間）取得自選股的「今日訊號」彙總表（包含動作、信心與簡述理由），以便快速掌握重點標的。

**Why this priority**: 提供日常決策所需之即時資訊，與回測互補。

**Independent Test**: 在任一交易日，對設定清單取得最近區間資料計算訊號，輸出 CSV 並印出摘要。

**Acceptance Scenarios**:
1. Given 有足量近期資料，When 產出今日訊號，Then 對每個標的產出一列包含日期、收盤、訊號、信心與理由，寫入 CSV。
2. Given 資料不足或空，When 產出今日訊號，Then 對該標的以 HOLD/Weak 並附註「資料不足」，流程不中斷。

---

### User Story 3 - 簡報骨架生成與嵌圖 (Priority: P3)

身為簡報準備者，我希望一鍵生成 20 頁的簡報骨架，並盡可能嵌入已產生的資產曲線圖，以便快速完成對外分享或內部檢討材料。

**Why this priority**: 提昇產出效率，縮短報告準備時間。

**Independent Test**: 在存在回測圖檔時，生成簡報並檢查相應頁面是否嵌入圖片；若無圖檔，則顯示友善占位文字。

**Acceptance Scenarios**:
1. Given backtest 圖檔存在，When 生成簡報，Then 於對應頁面呈現所有圖檔縮圖與標題說明。
2. Given 無任何圖檔，When 生成簡報，Then 仍產生 20 頁骨架並顯示「尚無圖檔」之類占位訊息。

---

### Edge Cases

- 設定檔缺漏或格式不正確：需明確錯誤訊息與退出碼，或採用清楚宣告的預設值。
- 目標期間內無資料／資料來源暫時不可用：不得中斷整批流程，需降級處理並標註。
- 生成輸出目錄不存在：應自動建立（不需使用者手動建資料夾）。
- 圖檔數量過多導致單頁擁擠：應合理縮放或分頁繼續（續頁）。
- 不同作業系統差異（字元編碼/路徑）：輸出檔名與編碼一致、可跨平台開啟。

## Requirements *(mandatory)*

### Functional Requirements

- FR-001：系統必須提供批次回測的命令入口，讀取既定設定（標的清單、期間、費用/滑價）並逐檔產出成果。
- FR-002：系統必須為每個回測標的輸出「資產曲線圖」與「交易點清單」兩類產物，並於終端顯示績效摘要（年化報酬、最大回撤）。
- FR-003：系統必須提供單檔回測入口，讓使用者可臨時檢視特定標的在特定期間的成果。
- FR-004：系統必須提供「今日訊號」彙總輸出，對每個標的至少包含日期、收盤價、訊號（買/賣/觀望）、信心等級與簡述理由。
- FR-005：系統在資料不足或計算無法進行時，必須以保守輸出（如 HOLD/Weak）並附註原因，而非整體失敗。
- FR-006：系統必須生成 20 頁簡報骨架，並嘗試嵌入已存在之資產曲線圖；若無圖則以占位文字表示。
- FR-007：系統必須提供打包交付物的能力，將簡報、回測輸出、設定與工作流程檔彙整成單一壓縮檔。
- FR-008：所有輸出檔若目錄不存在，系統必須自動建立；所有正常完成之流程退出碼為 0，錯誤退出碼非 0 並附人類可讀訊息。

### Key Entities *(include if feature involves data)*

- 回測任務：輸入（標的、期間、費用/滑價）、輸出（資產曲線圖、交易點清單、績效摘要）。
- 訊號紀錄：日期、標的、收盤價、訊號（買/賣/觀望）、信心等級、簡述理由、備註。
- 簡報成果：20 頁頁面結構、已嵌入圖檔（若有）、標題與說明文字。
- 交付包：包含簡報、回測輸出目錄、設定檔與流程設定之壓縮檔。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- SC-001：批次回測對設定清單中的所有標的產生完整輸出（圖+表）之成功率達 95% 以上（在資料可得前提）。
- SC-002：今日訊號彙總在 1 分鐘內產出並包含所有標的之紀錄（資料可得前提），缺資料者以保守輸出記錄在案。
- SC-003：簡報生成後可於常見簡報工具開啟，並正確顯示已存在之圖檔；最終檔名與頁數符合規範（20 頁）。
- SC-004：打包交付物產出單一壓縮檔，包含約定之內容，並可於另一台機器成功解壓與開啟。
- SC-005：使用者能在首次嘗試內完成核心任務（批次回測或今日訊號輸出），且無需手動建立任何資料夾。

### Assumptions

- 使用者已具備可用的標的清單與回測期間定義；若缺漏則以錯誤訊息提示並停止或採預設處理（有記錄）。
- 資料來源在一般情況下可取得歷史與近期收盤資料；短暫不可用時以保守輸出與明確標註處理。
- 產出檔案的資料夾結構與檔名規則保持穩定，便於自動化彙整與分享。

