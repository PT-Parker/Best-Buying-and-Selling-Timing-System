# Feature Specification: n8n Update Workflow Parameters

**Feature Branch**: `006-speckit-run-n8n`  
**Created**: 2025-10-20  
**Status**: Draft  
**Input**: User description: "speckit run n8n_update_workflow_params"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 更新指定工作流參數 (Priority: P1)

作為維運/營運人員，我想針對特定 n8n 工作流更新其「工作流參數」（key=value），以便快速套用新設定而不需手動進入介面逐一修改。

**Why this priority**: 這是最直接創造價值的核心流程，能將高頻率、易出錯的手動操作自動化，降低風險與時間成本。

**Independent Test**: 僅以單一工作流與 1 組參數進行更新，驗證前後參數差異與產出稽核紀錄即可獨立驗證。

**Acceptance Scenarios**:

1. **Given** 存在可存取之目標工作流，**When** 使用者提供工作流識別與一組 key=value，**Then** 系統應更新該參數並回報更新結果與舊新值。
2. **Given** 參數值未變更，**When** 執行更新，**Then** 系統應顯示「無變更」並仍寫入稽核紀錄（含時間與操作者）。

---

### User Story 2 - 預覽（Dry-run）不落地 (Priority: P2)

作為審慎操作的使用者，我想先預覽將被更新的參數差異與影響，確認無誤後再落地，避免誤更新。

**Why this priority**: Dry-run 能顯著降低操作風險，特別在生產環境或大量更新時。

**Independent Test**: 開啟 dry-run 模式，檢視輸出是否包含即將變更的鍵、舊值/新值與影響摘要，且實際狀態不被改變。

**Acceptance Scenarios**:

1. **Given** 存在可更新的參數，**When** 以 dry-run 模式執行，**Then** 僅輸出差異清單與影響摘要，不應有任何參數被實際更新。

---

### User Story 3 - 批次更新多個工作流 (Priority: P3)

作為管理多個工作流的使用者，我想對多個工作流進行批次參數更新（依名稱清單或規則），以便一次性完成大規模配置調整。

**Why this priority**: 批次能力提升效率，降低重複性操作與人為錯誤。

**Independent Test**: 指定 2–3 個工作流與 1–2 組相同參數，驗證所有目標皆更新、逐一生成稽核紀錄且錯誤個案不影響其他項目。

**Acceptance Scenarios**:

1. **Given** 提供多個工作流識別與同一組參數，**When** 執行批次更新，**Then** 成功更新者應逐一回報，失敗者應提供明確錯誤訊息且不影響其他工作流的更新。

---

### Edge Cases

- 目標工作流不存在或無存取權限：應回報清楚錯誤並不中斷其他項目的處理。
- 參數鍵不存在或不可變更：預設拒絕並提示；可由旗標允許建立新鍵 [NEEDS CLARIFICATION: 是否允許建立新參數鍵？]。
 - 參數鍵不存在或不可變更：直接拒絕並提示，不建立新鍵。
- 提供的值型別不符合預期（如布林/數值/清單）：應明確提示並拒絕更新該鍵。
- 實際無變更（新值等於舊值）：回報無變更並照樣寫入稽核紀錄。
- 發生連線/驗證失敗：提供可重試建議與錯誤碼摘要；不得產生半套用狀態。
- 批次更新部分成功：成功者落地且寫入紀錄，失敗者提供詳列原因，整體回傳彙總結果。

## Requirements *(mandatory)*

### Functional Requirements

 - **FR-001**: 系統必須允許以「唯一 ID」鎖定單一目標工作流（僅支援 ID，避免名稱衝突）。
- **FR-002**: 系統必須接受一組或多組 `key=value` 參數，對應到目標工作流的「工作流參數」。
- **FR-003**: 系統必須在執行前提供「變更前快照」與「將套用之差異摘要」。
- **FR-004**: 系統必須提供 dry-run 模式，僅輸出差異與影響，且不落地任何變更。
- **FR-005**: 系統必須於成功落地後，輸出「變更後快照」並產生稽核紀錄（含操作者、時間、目標、差異、結果）。
- **FR-006**: 系統必須支援批次指定多個目標工作流，逐一更新並彙整成功/失敗清單。
 - **FR-007**: 當提供之參數鍵不存在時，必須拒絕更新並提示，不支援建立新鍵。
- **FR-008**: 系統必須對值型別做基本驗證（數值、布林、字串、清單），不符合時拒絕該鍵並保留其他鍵處理。
- **FR-009**: 系統必須在錯誤情況下回傳具體可診斷訊息（缺權限、找不到、驗證失敗、逾時）。
- **FR-010**: 系統必須避免半套用狀態；若部分鍵失敗，不得覆寫成功鍵的落地行為（逐鍵原子性或逐工作流原子性皆可，但需一致）。
 - **FR-011**: 系統必須於操作前顯示單一「預設環境」之確認提示（僅單一環境，不支援環境切換）。
- **FR-012**: 系統必須將所有操作輸出到標準輸出，並可選擇寫入檔案（如 logs/ 目錄）供稽核追蹤。

### Key Entities *(include if feature involves data)*

- **Workflow（工作流）**: 可被辨識與更新參數的單位；屬性含名稱、唯一識別、可更新之參數清單。
- **Parameter（參數）**: 以鍵值對形式存在的設定項；屬性含鍵、值、值型別、是否允許新增/覆寫。
- **Update Request（更新請求）**: 一次操作的意圖與內容；屬性含操作者、目標工作流清單、鍵值對、dry-run 與旗標設定。
- **Audit Record（稽核紀錄）**: 對每個目標（或每次請求）產生；屬性含時間、操作者、前後快照、差異、成功/失敗與原因。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者可在 2 分鐘內完成單一工作流 1–5 個參數的更新（含預覽與確認）。
- **SC-002**: 批次更新 5–20 個工作流時，90% 任務可在 5 分鐘內完成（不含外部系統佇列延遲）。
- **SC-003**: 100% 成功與失敗案例皆產生完整稽核紀錄（含前後快照與差異）。
- **SC-004**: 首月導入使手動介面調整相關支援請求量降低 50% 以上。
- **SC-005**: 預覽（dry-run）在首次嘗試的採用率達 80% 以上（顯示風險意識提升）。

## Assumptions

- 工作流可由「名稱」或「唯一 ID」辨識；若名稱多筆匹配則需由使用者精確指定。
- 參數以鍵值對為主，允許多種基本型別；進階型別或巢狀結構不在本次範圍內。
- 稽核紀錄對合規與追蹤至關重要，預設開啟且可輸出為檔案。
- 允許以安全方式指定目標環境，但不在此規格內揭露任何認證技術細節。
