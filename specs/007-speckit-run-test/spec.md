# Feature Specification: Test n8n Webhook

**Feature Branch**: `007-speckit-run-test`  
**Created**: 2025-10-20  
**Status**: Draft  
**Input**: User description: "speckit run test_n8n_webhook"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 以預設負載測試單一 Webhook (Priority: P1)

作為維運/營運人員，我想對指定的 n8n Webhook URL 發送一個安全的預設測試負載，並立即看到是否成功（狀態碼、延遲與摘要），以快速確認端點可用與基本行為正常。

**Why this priority**: 最小成本即可驗證可用性，滿足日常健康檢查與故障排除。

**Independent Test**: 僅以一個 URL 與系統內建的預設測試負載進行測試，確認 2xx 成功與延遲量測即可。

**Acceptance Scenarios**:

1. **Given** 使用者提供可到達之 Webhook 完整 URL，**When** 送出預設測試負載，**Then** 應回報 2xx 狀態、量測延遲並標示結果為「成功」。
2. **Given** 端點不可用或返回非 2xx，**When** 送出預設測試負載，**Then** 應回報實際狀態碼、錯誤摘要與標示結果為「失敗」。

---

### User Story 2 - 使用自訂 JSON 負載測試 (Priority: P2)

作為開發/測試人員，我想在送出前檢查與預覽自訂 JSON 測試負載，確保格式正確並掌握與預設負載的差異。

**Why this priority**: 便於針對特定流程分支或欄位行為進行驗證。

**Independent Test**: 提供一份自訂 JSON，系統於送出前進行基本格式驗證並顯示與預設負載差異，之後送出並回報結果。

**Acceptance Scenarios**:

1. **Given** 使用者提供可解析之 JSON 字串，**When** 檢查與送出，**Then** 顯示格式有效、差異摘要並產出測試結果。
2. **Given** 使用者提供無法解析之 JSON 字串，**When** 檢查，**Then** 清楚提示格式錯誤並阻止送出。

---

### User Story 3 - 產生可稽核的測試紀錄 (Priority: P3)

作為稽核/管理人員，我想保留每次測試的摘要紀錄（時間、URL 掩碼、負載大小、結果、延遲），以便追蹤與比較歷史狀態。

**Why this priority**: 追蹤可靠度與問題發生時段，便於回溯。

**Independent Test**: 單次測試完成後，能取得一筆紀錄（不含敏感資訊），可供後續檢閱。

**Acceptance Scenarios**:

1. **Given** 完成一次測試，**When** 檢視輸出，**Then** 可看到測試時間、URL 掩碼（例如只顯示網域與路徑前綴）、負載大小、狀態碼、延遲與成功/失敗標示。

---

### Edge Cases

- URL 不合法或缺少必要部分：應在送出前即時提示錯誤。
- 端點逾時：應於合理逾時設定內結束並標示失敗，顯示延遲與逾時訊息。
- 非 2xx 回應（如 401/403/404/429/5xx）：應顯示狀態碼與摘要，標示失敗。
- 回應內容過大或非預期型態：仍以狀態碼與延遲作為判定基準，避免過度依賴內容。
- 自訂負載過大或含敏感字串：提醒使用者避免敏感資訊並限制顯示內容；輸出時不回顯完整內容。
- 無網路或 TLS 錯誤：清楚提示連線問題並建議檢查連線設定。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須允許使用者提供完整的 Webhook URL，並以該 URL 為測試目標（不支援名稱查找或 ID 解析）。
- **FR-002**: 系統必須在未提供自訂負載時，使用安全的預設測試負載（僅含不具業務影響的測試欄位）。
- **FR-003**: 系統必須回報測試狀態包含：成功/失敗、HTTP 狀態碼與量測延遲（毫秒）。
- **FR-004**: 系統必須在送出前檢查自訂 JSON 負載的格式是否有效；無效則拒絕送出並提示。
- **FR-005**: 系統必須於合理的預設逾時內完成測試；逾時則回報失敗並標示逾時。
- **FR-006**: 系統必須在輸出中避免洩漏敏感資訊（例如完整查詢字串或授權憑證）；對 URL 進行掩碼處理。
- **FR-007**: 系統必須在每次測試後產生一則摘要紀錄（時間、URL 掩碼、負載大小、結果、狀態碼、延遲）。
- **FR-008**: 系統不得持久化任何憑證或敏感資訊；所有敏感輸入僅用於當次測試流程。
- **FR-009**: 系統不得執行副作用指令；其目的僅為發送測試請求並報告結果。

### Key Entities *(include if feature involves data)*

- **WebhookTarget（Webhook 目標）**: 使用者輸入的完整 URL；用於測試連線與回應行為。
- **TestPayload（測試負載）**: 預設或自訂的 JSON 測試資料；僅為驗證使用。
- **TestRun（測試執行）**: 一次測試操作的上下文；包含時間、URL 掩碼、負載大小、逾時設定。
- **TestResult（測試結果）**: 測試的輸出摘要；包含成功/失敗、狀態碼、延遲、訊息與紀錄位置。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者可在 1 分鐘內完成單一 Webhook 測試並取得結果摘要。
- **SC-002**: 對於可到達且回應正常的端點，95% 測試在 3 秒內返回結果。
- **SC-003**: 100% 測試皆產生摘要紀錄且不含敏感資訊外洩。
- **SC-004**: 因端點可用性不明造成的支援請求量在導入後下降 40% 以上。

## Assumptions

- 使用者可提供完整且可公開連線的 Webhook URL；若端點需要密鑰或私有連線，使用者應自行在 URL 中包含必要查詢參數或於環境中已完成允許（本功能不處理憑證配置）。
- 預設測試負載僅用於可用性驗證，不包含任何業務資料。
- 本功能以單一端點單次測試為主；不包含批次測試、重試與排程等進階能力。

