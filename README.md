# 股市進出場時機系統（Streamlit 版）

單一入口的 Streamlit 應用，整合行情抓取（yfinance）、特徵工程、模型訓練/驗證、回測績效、決策卡與待執行清單。支援自動刷新行情、調整驗證視窗、模擬下單與操作日誌。

## 功能亮點
- **即時決策卡**：最新行情＋模型機率＋期望報酬，低於門檻或期望報酬為負時自動顯示觀望；達標可一鍵加入待執行清單。
- **自動刷新行情**：側邊欄可設定刷新秒數（0=關閉），定期重跑決策。
- **可調驗證視窗**：自訂「驗證天數」與「驗證結束日」，重新訓練時會依設定切出訓練/驗證資料。
- **模型訓練與回測**：XGBoost 分類器，訓練時引入隨機種子確保每次重訓結果不同；驗證回測展示年化報酬、最大回撤、勝率、交易紀錄與資金曲線。
- **價格預測**：以最新模型的機率與停利/停損推算未來 N 日價格走勢。
- **待執行清單／模擬下單**：決策卡可加入待執行單，支援「模擬成交／取消」並保留操作日誌，可下載 CSV。
- **參數控管**：側邊欄可調 EMA、RSI、布林、停利停損、初始資金、模型機率門檻、驗證視窗。

## 專案結構
```
app.py                  # Streamlit 入口與 UI/流程
core/                   # backtest、特徵、標記、模型訓練
services/               # 資料來源、信號彙總、回測、模型 registry
config/                 # watchlist + 策略/標記預設
models/                 # 最新模型檔 (model_latest.json)
metrics/                # 模型 registry（JSONL）
tests/                  # 單元測試
.streamlit/             # Streamlit 設定
```

## 安裝與執行
1) 安裝套件（Python 3.10+）  
```bash
python -m venv .venv
.venv\Scripts\activate   # Windows
pip install -r requirements.txt
```
2) 啟動  
```bash
streamlit run app.py
```
3) 使用方式  
- 選擇股票、資料期間，調整技術參數、模型門檻、初始資金、驗證視窗。  
- 按「更新行情並生成今日決策卡」取得最新建議；若顯示「考慮進場」可加入待執行清單。  
- 若需更新模型，按「以目前資料重新訓練模型」；訓練後會自動刷新決策卡並重置待執行單/日誌。  
- 「生成價格預測」可查看未來 N 日價格推估。

## 在線 demo
已部署於 Streamlit Cloud：  
https://best-buying-and-selling-timing-system-7xadsrumttrvw6tffxn6y2.streamlit.app/

## 主要參數
- **自動刷新行情**：0 表示關閉，自訂秒數可定期重算決策。  
- **驗證天數／驗證結束日**：決定訓練/驗證切分，回測績效與決策卡依此更新。  
- **模型進場機率門檻**：低於門檻或期望報酬 <= 0 則觀望。  
- **初始資金**：預設 1,500,000，用於回測與風險預算（建議部位計算）。  

## 測試
```bash
pytest
```

## 注意事項
- 只支援 yfinance 資料來源，需可連外。  
- 每次訓練使用當前時間作為 random_state，結果會有隨機性；如需可重現，請自行固定 random_state。  
- 待執行清單與日誌儲存在 session_state，重啟後需重新產生。  
- 推送前請確保未包含任何敏感金鑰或憑證。  
- 部署前請設定環境變數 `CRYPTOPANIC_API_KEY`/`GNEWS_API_KEY` 供情緒代理抓取真實新聞；未設定時將回退為模擬標題，不影響執行。
